---
- hosts: fuel
  connection: local
  vars_files:
    - "vars/mos_releases/{{ mos_release }}.yml"
  tasks:

  - block:
      - name: Stop docker containers
        command: dockerctl stop all

      - name: Make a backup of docker containers
        command: dockerctl backup "{{ fuel_backup_dir }}"

      - name: Make a backup of docker containers data
        shell: tar -czf "{{ fuel_backup_dir }}"/fuel__$(date +%m.%d.%y__%H-%M-%S).tgz /var/lib/fuel

      - name: Yum update
        command: yum update

      - name: Load new Fuel images
        command: docker load -i /var/www/nailgun/docker/images/fuel-images.tar

      - name: Destroy docker containers
        command: dockerctl destroy all

    always:
      - name: Start docker containers
        command: dockerctl start all
